<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DiNKR Pickleball Americano Tournament</title>
    <!-- Reliable CDN sources for React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif; 
            background: #325682; 
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
            padding-bottom: 60px;
            color: white;
        }
        
        .btn { 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.2s; 
            touch-action: manipulation;
            -webkit-appearance: none;
            user-select: none;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover, .btn:active { 
            transform: translateY(-1px); 
            opacity: 0.9;
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
        }
        
        .input, .select { 
            border: 2px solid #64748b; 
            border-radius: 4px; 
            padding: 12px; 
            font-size: 16px;
            outline: none;
            touch-action: manipulation;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            min-height: 44px;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
        }
        .input:focus, .select:focus { 
            border-color: #deff01; 
        }
        .input::-webkit-outer-spin-button,
        .input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .card { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border-radius: 12px; 
            padding: 20px; 
            margin: 16px auto;
            width: 100%;
        }
        
        .error-message {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .success-message {
            background: #c6f6d5;
            color: #276749;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #deff01;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .court-wrapper {
            margin: 0 auto 24px;
            max-width: 100%;
            width: 100%;
        }
        .court-container {
            background: #f7fafc;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: 2fr 1fr 4px 1fr 2fr;
            border: 2px solid white;
            border-radius: 0px;
            width: 100%;
            max-width: 380px;
            margin: 0 auto;
        }
        .court-team {
            display: grid;
            grid-template-rows: 1fr 1fr;
        }
        .court-team.left {
            border-right: 2px solid white;
        }
        .court-team.right {
            border-left: 2px solid white;
        }
        .court-player {
            background-color: #325682;
            color: white;
            text-align: center;
            padding: 20px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            transition: all 0.2s;
            line-height: 1.2;
        }
        .court-player.top {
            border-bottom: 2px solid white;
        }
        .court-player.duplicate {
            background-color: #dc2626 !important;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .court-score-input {
            width: 52px;
            height: 52px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            border: none;
            background-color: white;
            outline: none;
            border-radius: 0px;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        .court-score-input:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .number-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .number-input-btn {
            background: #deff01;
            color: #1a202c;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-appearance: none;
            user-select: none;
        }
        .number-input-btn:hover, .number-input-btn:active {
            background: #c5d601;
            transform: translateY(-1px);
        }
        .number-input-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .timer-display {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 28px;
            font-weight: bold;
            border: 3px solid #000;
            min-width: 120px;
            text-align: center;
        }
        .timer-normal {
            background-color: #000;
            color: white;
        }
        .timer-warning {
            background-color: #dc2626;
            color: white;
            animation: pulse 1s infinite;
        }
        
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }
        .dialog-content {
            background-color: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            color: #1a202c;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        input[type="tel"], 
        input[type="text"], 
        input[type="number"], 
        select {
            font-size: 16px;
            transform: translateZ(0);
        }
        
        html { 
            scroll-behavior: smooth; 
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 24px;
        }
        .logo-icon {
            width: 80px;
            height: 80px;
            background: #deff01;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 16px;
        }
        .logo-text {
            font-size: 36px;
            font-weight: bold;
            color: #deff01;
            letter-spacing: 2px;
        }
        .logo-tagline {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }
        
        .header {
            background-color: #1a202c;
            color: white;
            padding: 12px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-back {
            padding: 8px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 20px;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-title {
            font-size: 18px;
            font-weight: bold;
            color: #deff01;
        }
        .header-spacer {
            width: 40px;
        }

        .results-grid {
            display: grid;
            gap: 8px;
            margin: 16px 0;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .result-item.winner {
            background-color: rgba(222, 255, 1, 0.1);
            border: 1px solid #deff01;
        }

        /* SKIP/REASSIGN UI Styles */
        .management-panel {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .management-btn {
            background: #64748b;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
        }
        .management-btn.active {
            background: #deff01;
            color: #1a202c;
        }
        .skip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }
        .skip-player {
            background: #dc2626;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .skip-player button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 2px;
            color: white;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 12px;
        }
        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin: 12px 0;
        }
        .player-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .player-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .player-btn.selected {
            background: #deff01;
            color: #1a202c;
            border-color: #deff01;
        }
        
        .court-validation-error {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 12px;
            border-radius: 6px;
            margin: 16px 0;
            font-size: 14px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column;">
            <div class="logo-container">
                <div class="logo-icon">üèì</div>
                <div class="logo-text">DiNKR</div>
                <div class="logo-tagline">MEET YOUR MATCH</div>
            </div>
            <div class="spinner"></div>
            <p style="margin-top: 20px;">Loading Tournament System...</p>
        </div>
    </div>
    
    <script>
        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; text-align: center; background: #325682; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <h2 style="color: #dc2626; margin-bottom: 20px;">‚ö†Ô∏è Loading Error</h2>
                    <p style="margin-bottom: 20px;">React components failed to load.</p>
                    <p style="font-size: 14px; color: #94a3b8;">Error: ${e.error ? e.error.message : 'Unknown error'}</p>
                    <button onclick="window.location.reload()" style="background: #deff01; color: #1a202c; border: none; padding: 12px 24px; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold;">Reload Page</button>
                </div>
            `;
        });

        // Check if React loaded
        if (typeof React === 'undefined') {
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; text-align: center; background: #325682; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <h2 style="color: #dc2626; margin-bottom: 20px;">React Loading Failed</h2>
                    <p style="margin-bottom: 20px;">CDN connection issue. Check internet.</p>
                    <button onclick="window.location.reload()" style="background: #deff01; color: #1a202c; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">Retry</button>
                </div>
            `;
        } else {
            // React loaded successfully, initialize app
            const { useState, useCallback, useEffect, createElement: h } = React;
            
            // Utility function for creating elements
            const createEl = (type, props = {}, ...children) => {
                try {
                    return h(type, props, ...children);
                } catch (error) {
                    console.error('Error creating element:', error);
                    return h('div', { style: { color: 'red' } }, 'Component Error');
                }
            };

            // *** NEW: API URL Helper ***
            const getApiUrl = (path) => `${window.location.origin}${path}`;
            
            // Icon Components
            const ChevronLeft = () => createEl('span', { style: { fontSize: '20px' } }, '‚Üê');
            const Trophy = () => createEl('span', { style: { fontSize: '40px' } }, 'üèÜ');
            const Settings = () => createEl('span', { style: { fontSize: '18px' } }, '‚öôÔ∏è');
            
            // Logo Component
            const DiNKRLogo = ({ size = 'normal' }) => {
                const logoSize = size === 'large' ? 80 : 60;
                const textSize = size === 'large' ? '36px' : '28px';
                
                return createEl('div', { className: 'logo-container' }, [
                    createEl('div', { 
                        key: 'icon',
                        className: 'logo-icon',
                        style: { 
                            width: logoSize + 'px', 
                            height: logoSize + 'px',
                            fontSize: Math.round(logoSize * 0.5) + 'px'
                        } 
                    }, 'üèì'),
                    createEl('div', { key: 'text' }, [
                        createEl('div', { 
                            key: 'title',
                            className: 'logo-text',
                            style: { fontSize: textSize }
                        }, 'DiNKR'),
                        createEl('div', { 
                            key: 'tagline',
                            className: 'logo-tagline' 
                        }, 'MEET YOUR MATCH')
                    ])
                ]);
            };
            
            // FIXED: Number Input Component with proper courts/players relationship
            const NumberInput = ({ value, onChange, min = 1, max = 100, label, helpText }) => {
                const increment = () => {
                    const newValue = value < max ? value + 1 : value;
                    onChange(newValue);
                };
                
                const decrement = () => {
                    const newValue = value > min ? value - 1 : value;
                    onChange(newValue);
                };
                
                const handleInputChange = (e) => {
                    const newValue = parseInt(e.target.value) || min;
                    const clampedValue = Math.max(min, Math.min(max, newValue));
                    onChange(clampedValue);
                };

                return createEl('div', { style: { marginBottom: '20px' } }, [
                    createEl('label', { 
                        key: 'label',
                        style: { 
                            display: 'block', 
                            fontSize: '16px', 
                            fontWeight: '500', 
                            marginBottom: '8px', 
                            color: 'white' 
                        } 
                    }, label),
                    createEl('div', { key: 'controls', className: 'number-input-container' }, [
                        createEl('button', {
                            key: 'dec',
                            onClick: decrement,
                            disabled: value <= min,
                            className: 'number-input-btn',
                            type: 'button'
                        }, '‚àí'),
                        createEl('input', { 
                            key: 'input',
                            type: 'number', 
                            min, 
                            max, 
                            value, 
                            onChange: handleInputChange,
                            className: 'input', 
                            style: { 
                                width: '100px',
                                textAlign: 'center',
                                backgroundColor: 'rgba(255, 255, 255, 0.15)', 
                                border: '2px solid rgba(255, 255, 255, 0.3)', 
                                color: 'white'
                            } 
                        }),
                        createEl('button', {
                            key: 'inc',
                            onClick: increment,
                            disabled: value >= max,
                            className: 'number-input-btn',
                            type: 'button'
                        }, '+')
                    ]),
                    helpText ? createEl('p', { 
                        key: 'help',
                        style: { fontSize: '14px', color: '#94a3b8', marginTop: '6px' } 
                    }, helpText) : null
                ]);
            };

            // NEW: Player Management Component
            const PlayerManagement = ({ players, onUpdate, currentSkips = [], onlyMixedDoubles }) => {
                const [mode, setMode] = useState('skip'); // 'skip' or 'reassign'
                const [localSkips, setLocalSkips] = useState(currentSkips);
                const [selectedPlayer, setSelectedPlayer] = useState(null);
                
                const addSkip = (playerName) => {
                    if (!localSkips.includes(playerName)) {
                        const newSkips = [...localSkips, playerName];
                        setLocalSkips(newSkips);
                        onUpdate({ skipPlayers: newSkips });
                    }
                };
                
                const removeSkip = (playerName) => {
                    const newSkips = localSkips.filter(p => p !== playerName);
                    setLocalSkips(newSkips);
                    onUpdate({ skipPlayers: newSkips });
                };

                const handleReassignSelect = (playerName) => {
                    setSelectedPlayer(playerName);
                };

                const handleReassignReplace = (replacementName) => {
                    if (selectedPlayer && replacementName !== selectedPlayer) {
                        onUpdate({
                            playerSwitches: [{ oldPlayer: selectedPlayer, newPlayer: replacementName }]
                        });
                        setSelectedPlayer(null); // Reset after switch
                    }
                };

                const getEligibleReplacements = () => {
                    if (!selectedPlayer) return [];
                    
                    const selectedPlayerData = players.find(p => p.name === selectedPlayer);
                    if (!selectedPlayerData) return [];

                    return players.filter(p => {
                        // Cannot replace with self or a skipping player
                        if (p.name === selectedPlayer || localSkips.includes(p.name)) return false;
                        // If only mixed doubles, must replace with same gender
                        if (onlyMixedDoubles && p.gender !== selectedPlayerData.gender) return false;
                        return true;
                    });
                };
                
                return createEl('div', { className: 'management-panel' }, [
                    createEl('div', { key: 'header', className: 'management-header' }, [
                        createEl('h3', { 
                            key: 'title',
                            style: { fontSize: '16px', color: '#deff01' } 
                        }, 'Player Management'),
                        createEl('div', { key: 'tabs', style: { display: 'flex', gap: '8px' } }, [
                            createEl('button', {
                                key: 'skip',
                                onClick: () => { setMode('skip'); setSelectedPlayer(null); },
                                className: `management-btn ${mode === 'skip' ? 'active' : ''}`,
                            }, 'Skip Players'),
                            createEl('button', {
                                key: 'reassign',
                                onClick: () => { setMode('reassign'); setSelectedPlayer(null); },
                                className: `management-btn ${mode === 'reassign' ? 'active' : ''}`,
                            }, 'Reassign')
                        ])
                    ]),
                    
                    mode === 'skip' ? [
                        localSkips.length > 0 ? createEl('div', { 
                            key: 'skip-list',
                            className: 'skip-list' 
                        }, localSkips.map(playerName => 
                            createEl('div', {
                                key: playerName,
                                className: 'skip-player'
                            }, [
                                createEl('span', { key: 'name' }, playerName),
                                createEl('button', {
                                    key: 'remove',
                                    onClick: () => removeSkip(playerName)
                                }, '√ó')
                            ])
                        )) : null,
                        createEl('div', { key: 'player-grid', className: 'player-list' }, 
                            players.filter(p => !localSkips.includes(p.name)).map(player => 
                                createEl('button', {
                                    key: player.name,
                                    onClick: () => addSkip(player.name),
                                    className: 'player-btn'
                                }, player.firstName || player.name)
                            )
                        )
                    ] : [
                        createEl('p', { 
                            key: 'instructions',
                            style: { fontSize: '14px', marginBottom: '12px', color: '#cbd5e0' } 
                        }, !selectedPlayer ? 
                            '1. Select player to move:' : 
                            `2. Replace ${selectedPlayer} with:`
                        ),
                        createEl('div', { key: 'player-grid', className: 'player-list' }, 
                            (!selectedPlayer ? players.filter(p => !localSkips.includes(p.name)) : getEligibleReplacements())
                            .map(player => 
                                createEl('button', {
                                    key: player.name,
                                    onClick: () => !selectedPlayer ? handleReassignSelect(player.name) : handleReassignReplace(player.name),
                                    className: `player-btn ${selectedPlayer === player.name ? 'selected' : ''}`,
                                }, player.firstName || player.name)
                            )
                        ),
                        selectedPlayer ? createEl('button', {
                            key: 'cancel',
                            onClick: () => setSelectedPlayer(null),
                            style: { marginTop: '12px', color: '#deff01', background: 'transparent', border: 'none', cursor: 'pointer' }
                        }, 'Cancel Reassignment') : null
                    ]
                ]);
            };

            // Score Validation Dialog
            const ScoreValidationDialog = ({ isOpen, onClose, teamAScore, teamBScore, onConfirm }) => {
                if (!isOpen) return null;

                return createEl('div', { className: 'dialog-overlay' }, [
                    createEl('div', { 
                        key: 'content',
                        className: 'dialog-content',
                        style: { maxWidth: '400px', textAlign: 'center' }
                    }, [
                        createEl('h2', { 
                            key: 'title',
                            style: { fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', color: '#dc2626' } 
                        }, '‚ö†Ô∏è Score Confirmation'),
                        createEl('p', { 
                            key: 'message',
                            style: { marginBottom: '20px', fontSize: '16px', lineHeight: '1.5' } 
                        }, `Neither team scored 11 points (${teamAScore} - ${teamBScore}). Please confirm or edit.`),
                        createEl('div', { 
                            key: 'score',
                            style: {
                                backgroundColor: '#f8f9fa',
                                padding: '16px',
                                borderRadius: '8px',
                                marginBottom: '24px',
                                fontSize: '24px',
                                fontWeight: 'bold',
                                color: '#325682'
                            }
                        }, `${teamAScore} - ${teamBScore}`),
                        createEl('div', { 
                            key: 'buttons',
                            style: { display: 'flex', gap: '16px', justifyContent: 'center', flexWrap: 'wrap' }
                        }, [
                            createEl('button', {
                                key: 'edit',
                                onClick: onClose,
                                className: 'btn',
                                style: {
                                    backgroundColor: '#64748b',
                                    color: 'white',
                                    padding: '16px 24px',
                                    borderRadius: '8px',
                                    fontSize: '16px'
                                }
                            }, 'Edit Score'),
                            createEl('button', {
                                key: 'confirm',
                                onClick: onConfirm,
                                className: 'btn',
                                style: {
                                    backgroundColor: '#deff01',
                                    color: '#1a202c',
                                    padding: '16px 24px',
                                    borderRadius: '8px',
                                    fontSize: '16px'
                                }
                            }, 'Confirm Score')
                        ])
                    ])
                ]);
            };

            // FIXED: Court Component with better player display and duplicate detection
            const Court = ({ match, matchIndex, roundIndex, courtNumber, scores, updateScore, onScoreValidation, roundStarted = true }) => {
                const [teamA, teamB, matchInfo] = match;
                const matchScores = scores[roundIndex]?.[matchIndex] || { teamA: '', teamB: '' };
                const violations = matchInfo?.violations || [];

                // ENHANCED: Validate no duplicate players across ALL positions in this court
                const allPlayersInCourt = [...teamA, ...teamB];
                const allPlayerNames = allPlayersInCourt.map(p => p.name);
                const uniquePlayerNames = new Set(allPlayerNames);
                const hasDuplicates = allPlayerNames.length !== uniquePlayerNames.size;
                
                // Find which players are duplicated
                const duplicatedPlayers = [];
                if (hasDuplicates) {
                    const nameCounts = {};
                    allPlayerNames.forEach(name => {
                        nameCounts[name] = (nameCounts[name] || 0) + 1;
                    });
                    duplicatedPlayers.push(...Object.keys(nameCounts).filter(name => nameCounts[name] > 1));
                }

                const handleScoreChange = (team, value) => {
                    if (!roundStarted) return;
                    updateScore(roundIndex, matchIndex, team, value);
                    
                    // Score validation logic
                    const otherTeam = team === 'teamA' ? 'teamB' : 'teamA';
                    const otherScore = team === 'teamA' ? matchScores.teamB : matchScores.teamA;
                    const currentTeamAScore = team === 'teamA' ? value : otherScore;
                    const currentTeamBScore = team === 'teamB' ? value : otherScore;
                    
                    if (currentTeamAScore && currentTeamBScore) {
                        const scoreA = parseInt(currentTeamAScore) || 0;
                        const scoreB = parseInt(currentTeamBScore) || 0;
                        
                        if ((scoreA >= 10 || scoreB >= 10) && scoreA < 11 && scoreB < 11 && (scoreA > 0 || scoreB > 0)) {
                            setTimeout(() => {
                                const finalA = parseInt(scores[roundIndex]?.[matchIndex]?.teamA) || 0;
                                const finalB = parseInt(scores[roundIndex]?.[matchIndex]?.teamB) || 0;
                                if (finalA < 11 && finalB < 11 && (finalA > 0 || finalB > 0)) {
                                    onScoreValidation(roundIndex, matchIndex, finalA, finalB);
                                }
                            }, 1000);
                        }
                    }
                };

                const renderPlayer = (player, position) => {
                    // IMPROVED: Show full name but truncate smartly if too long
                    const displayName = player.name.length > 12 ? 
                        (player.firstName || player.name.split(' ')[0]) : 
                        player.name;
                    
                    const isDuplicated = duplicatedPlayers.includes(player.name);
                    
                    return createEl('div', {
                        key: `player-${position}`,
                        className: `court-player ${position === 0 ? 'top' : ''} ${isDuplicated ? 'duplicate' : ''}`,
                        title: player.name // Show full name on hover
                    }, displayName);
                };

                return createEl('div', { className: 'court-wrapper' }, [
                    hasDuplicates ? createEl('div', {
                        key: 'error',
                        className: 'court-validation-error'
                    }, `üö® DUPLICATE PLAYER ERROR: ${duplicatedPlayers.join(', ')} appears multiple times in Court ${courtNumber}!`) : null,
                    
                    violations.length > 0 ? createEl('div', {
                        key: 'violation-error',
                        className: 'court-validation-error'
                    }, `‚ö†Ô∏è Rule Violation!`) : null,

                    createEl('div', { key: 'top-post', style: { display: 'flex', justifyContent: 'center', marginBottom: '4px' } },
                        createEl('div', { style: { width: '8px', height: '16px', backgroundColor: '#000' } })
                    ),
                    createEl('div', { key: 'court', className: 'court-container' }, [
                        createEl('div', { 
                            key: 'left-team', 
                            className: 'court-team left'
                        }, [
                            renderPlayer(teamA[0], 0),
                            renderPlayer(teamA[1], 1)
                        ]),
                        createEl('div', { 
                            key: 'left-score', 
                            style: { backgroundColor: '#a0aec0', display: 'flex', alignItems: 'center', justifyContent: 'center' } 
                        },
                            createEl('input', {
                                type: 'tel',
                                inputMode: 'numeric',
                                value: matchScores.teamA,
                                disabled: !roundStarted || hasDuplicates,
                                onChange: (e) => {
                                    const value = e.target.value.replace(/[^0-9]/g, '');
                                    const numValue = parseInt(value) || 0;
                                    if (value === '' || numValue <= 15) {
                                        handleScoreChange('teamA', value);
                                    }
                                },
                                onFocus: (e) => e.target.select(),
                                className: 'court-score-input',
                                placeholder: roundStarted ? '0' : '‚Äî'
                            })
                        ),
                        createEl('div', { key: 'net', style: { backgroundColor: '#000' } }),
                        createEl('div', { 
                            key: 'right-score', 
                            style: { backgroundColor: '#a0aec0', display: 'flex', alignItems: 'center', justifyContent: 'center' } 
                        },
                            createEl('input', {
                                type: 'tel',
                                inputMode: 'numeric',
                                value: matchScores.teamB,
                                disabled: !roundStarted || hasDuplicates,
                                onChange: (e) => {
                                    const value = e.target.value.replace(/[^0-9]/g, '');
                                    const numValue = parseInt(value) || 0;
                                    if (value === '' || numValue <= 15) {
                                        handleScoreChange('teamB', value);
                                    }
                                },
                                onFocus: (e) => e.target.select(),
                                className: 'court-score-input',
                                placeholder: roundStarted ? '0' : '‚Äî'
                            })
                        ),
                        createEl('div', { 
                            key: 'right-team', 
                            className: 'court-team right'
                        }, [
                            renderPlayer(teamB[0], 0),
                            renderPlayer(teamB[1], 1)
                        ])
                    ]),
                    createEl('div', { key: 'bottom-post', style: { display: 'flex', justifyContent: 'center', marginTop: '4px' } },
                        createEl('div', { style: { width: '8px', height: '16px', backgroundColor: '#000' } })
                    ),
                    createEl('div', { 
                        key: 'court-number', 
                        style: { textAlign: 'center', marginTop: '12px' } 
                    },
                        createEl('span', { 
                            style: { 
                                backgroundColor: hasDuplicates || violations.length > 0 ? '#dc2626' : '#deff01', 
                                color: hasDuplicates || violations.length > 0 ? 'white' : '#1a202c', 
                                fontWeight: 'bold', 
                                padding: '8px 16px', 
                                fontSize: '18px', 
                                borderRadius: '4px' 
                            } 
                        }, `Court ${courtNumber} ${violations.length > 0 ? '‚ö†Ô∏è' : ''}`)
                    )
                ]);
            };

            // Main Tournament App
            const TournamentApp = () => {
                const [step, setStep] = useState(1);
                const [config, setConfig] = useState({
                    courts: 2, 
                    totalPlayers: 8, 
                    rounds: 6, 
                    useDefaults: true,
                    avoidMMvsFF: true, 
                    useRatingBalance: true,
                    onlyMixedDoubles: false,
                    roundDuration: 13
                });
                const [players, setPlayers] = useState([]);
                const [tournament, setTournament] = useState(null);
                const [currentRound, setCurrentRound] = useState(0);
                const [scores, setScores] = useState({});
                const [phase, setPhase] = useState('setup');
                const [roundStarted, setRoundStarted] = useState(false);
                const [timeRemaining, setTimeRemaining] = useState(0);
                const [timerRunning, setTimerRunning] = useState(false);
                const [loading, setLoading] = useState(false);
                const [errorMessage, setErrorMessage] = useState('');
                const [successMessage, setSuccessMessage] = useState('');
                const [showManagement, setShowManagement] = useState(false);
                const [managementState, setManagementState] = useState({ skipPlayers: [], playerSwitches: [] });
                
                // FIXED: Move results state to top level to follow React rules
                const [results, setResults] = useState(null);
                const [resultsLoading, setResultsLoading] = useState(false);
                
                // Score validation state
                const [scoreValidation, setScoreValidation] = useState({
                    isOpen: false,
                    roundIndex: null,
                    matchIndex: null,
                    teamAScore: null,
                    teamBScore: null
                });

                // FIXED: Proper courts/players relationship
                const handleCourtsChange = (newCourts) => {
                    const minPlayers = newCourts * 4;
                    setConfig(prev => ({
                        ...prev,
                        courts: newCourts,
                        totalPlayers: Math.max(prev.totalPlayers, minPlayers)
                    }));
                };

                const handlePlayersChange = (newPlayers) => {
                    setConfig(prev => ({
                        ...prev,
                        totalPlayers: newPlayers
                    }));
                };

                const handlePlayerInfoChange = (index, field, value) => {
                    setPlayers(prev => {
                        const newPlayers = [...prev];
                        newPlayers[index][field] = value;
                        // Auto-generate name
                        const p = newPlayers[index];
                        p.name = `${p.firstName} ${p.lastName}`;
                        return newPlayers;
                    });
                };

                const addPlayer = () => {
                    setPlayers(prev => [...prev, { firstName: '', lastName: '', gender: 'M', rating: 3.5, name: '' }]);
                };

                const removePlayer = (index) => {
                    setPlayers(prev => prev.filter((_, i) => i !== index));
                };

                // Timer effect
                useEffect(() => {
                    let interval;
                    if (timerRunning && timeRemaining > 0) {
                        interval = setInterval(() => {
                            setTimeRemaining(prev => {
                                if (prev <= 1) {
                                    setTimerRunning(false);
                                    return 0;
                                }
                                return prev - 1;
                            });
                        }, 1000);
                    }
                    return () => clearInterval(interval);
                }, [timerRunning, timeRemaining]);

                // FIXED: Results calculation effect
                useEffect(() => {
                    if (phase === 'completed' && !results && !resultsLoading) {
                        setResultsLoading(true);
                        calculateTournamentResults()
                            .then(calculatedResults => {
                                console.log('Calculated results:', calculatedResults);
                                setResults(calculatedResults);
                            })
                            .catch(error => {
                                console.error('Error calculating results:', error);
                                showError('Failed to calculate tournament results');
                            })
                            .finally(() => {
                                setResultsLoading(false);
                            });
                    }
                }, [phase, results, resultsLoading]);

                const showError = (message) => {
                    console.error('DiNKR Error:', message);
                    setErrorMessage(message);
                    setTimeout(() => setErrorMessage(''), 8000); // Longer display for errors
                };

                const showSuccess = (message) => {
                    console.log('DiNKR Success:', message);
                    setSuccessMessage(message);
                    setTimeout(() => setSuccessMessage(''), 3000);
                };

                const generateTournament = async () => {
                    setLoading(true);
                    setErrorMessage('');
                    
                    try {
                        const requestData = {
                            ...config,
                            players: config.useDefaults ? [] : players,
                        };

                        console.log('Sending tournament request:', requestData);

                        const response = await fetch(getApiUrl('/api/generate_tournament'), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });

                        const result = await response.json();
                        console.log('Tournament response:', result);

                        if (response.ok && result.success) {
                            setTournament(result);
                            setCurrentRound(0);
                            setScores({});
                            setPhase('setup');
                            setManagementState({ skipPlayers: [], playerSwitches: [] });
                            setResults(null); // Reset results
                            showSuccess('Tournament generated! Review Round 1 assignments.');
                            setStep(3);
                        } else {
                            showError(result.error || 'Failed to generate tournament');
                        }
                    } catch (error) {
                        console.error('Tournament generation error:', error);
                        showError('Network error: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };

                const updateScore = async (roundIndex, matchIndex, team, score) => {
                    try {
                        const response = await fetch(getApiUrl('/api/update_score'), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ roundIndex, matchIndex, team, score })
                        });

                        if (response.ok) {
                            setScores(prev => ({
                                ...prev,
                                [roundIndex]: {
                                    ...prev[roundIndex],
                                    [matchIndex]: { 
                                        ...prev[roundIndex]?.[matchIndex], 
                                        [team]: score 
                                    }
                                }
                            }));
                        }
                    } catch (error) {
                        showError('Failed to update score');
                    }
                };

                const handleScoreValidation = (roundIndex, matchIndex, teamAScore, teamBScore) => {
                    setScoreValidation({
                        isOpen: true,
                        roundIndex,
                        matchIndex,
                        teamAScore,
                        teamBScore
                    });
                };

                const confirmScore = () => {
                    setScoreValidation({
                        isOpen: false,
                        roundIndex: null,
                        matchIndex: null,
                        teamAScore: null,
                        teamBScore: null
                    });
                };

                const isRoundComplete = (roundIndex) => {
                    if (!tournament || !scores[roundIndex]) return false;
                    const roundMatches = tournament.schedule[roundIndex]?.matches || [];
                    return roundMatches.every((match, matchIndex) => {
                        const matchScores = scores[roundIndex][matchIndex];
                        return matchScores && matchScores.teamA && matchScores.teamB;
                    });
                };

                const startRound = () => {
                    setRoundStarted(true);
                    setTimeRemaining(config.roundDuration * 60);
                    setTimerRunning(true);
                    setPhase('playing');
                    setShowManagement(false);
                };

                const advanceRound = async () => {
                    if (currentRound >= tournament.schedule.length - 1) {
                        setPhase('completed');
                        return;
                    }

                    try {
                        setLoading(true);
                        console.log('Advancing to next round...');
                        
                        const response = await fetch(getApiUrl('/api/advance_round'), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(managementState)
                        });

                        const result = await response.json();
                        console.log('Advance round response:', result);

                        if (result.completed) {
                            setPhase('completed');
                            return;
                        }

                        if (!response.ok) {
                            showError(result.error || 'Failed to advance round');
                            return;
                        }

                        if (result.success) {
                            // Fetch fresh tournament state
                            const stateResponse = await fetch(getApiUrl('/api/get_tournament_state'));
                            
                            if (!stateResponse.ok) {
                                throw new Error('Failed to fetch tournament state');
                            }
                            
                            const state = await stateResponse.json();
                            console.log('Fresh tournament state:', state);
                            
                            if (state.tournament && state.tournament.schedule) {
                                setTournament(state.tournament);
                                setCurrentRound(state.current_round);
                                setScores(state.scores || {});
                                setRoundStarted(false);
                                setTimerRunning(false);
                                setTimeRemaining(0);
                                setPhase('setup');
                                setManagementState({ skipPlayers: [], playerSwitches: [] });
                                
                                showSuccess(`Advanced to Round ${result.round + 1}`);
                            } else {
                                showError('Tournament state is invalid after round advancement');
                            }
                        } else {
                            showError(result.error || 'Failed to advance round');
                        }
                    } catch (error) {
                        console.error('Round advancement error:', error);
                        showError('Network error: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                };

                const handleManagementUpdate = async (updates) => {
                    setLoading(true);
                    try {
                        const response = await fetch(getApiUrl('/api/update_round_assignments'), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                skipPlayers: updates.skipPlayers || managementState.skipPlayers,
                                playerSwitches: updates.playerSwitches || []
                            })
                        });
                        const result = await response.json();
                        if (result.success) {
                            setTournament(prev => {
                                const newSchedule = [...prev.schedule];
                                newSchedule[currentRound] = result.new_schedule;
                                return { ...prev, schedule: newSchedule };
                            });
                            setManagementState(prev => ({ ...prev, ...updates, playerSwitches: [] }));
                            showSuccess('Round updated.');
                        } else {
                            showError(result.error || 'Failed to update assignments');
                        }
                    } catch (error) {
                        showError('Network error updating assignments.');
                    } finally {
                        setLoading(false);
                    }
                };

                const calculateTournamentResults = async () => {
                    try {
                        console.log('Calculating tournament results...');
                        const response = await fetch(getApiUrl('/api/calculate_results'));
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const resultsData = await response.json();
                        console.log('Raw results from API:', resultsData);
                        
                        if (resultsData.error) {
                            throw new Error(resultsData.error);
                        }
                        
                        if (!resultsData.dinkrAnalysis) {
                            throw new Error('Results data is malformed');
                        }
                        
                        return resultsData;
                        
                    } catch (error) {
                        console.error('Error calculating results:', error);
                        throw error;
                    }
                };

                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                const isLastMinute = timeRemaining <= 60 && timeRemaining > 0;
                
                const isConfigValid = () => {
                    if (config.useDefaults) {
                        const minPlayers = config.courts * 4;
                        return config.totalPlayers >= minPlayers;
                    } else {
                        const minPlayers = config.courts * 4;
                        if (players.length < minPlayers) return false;
                        return players.every(p => p.firstName && p.lastName);
                    }
                };

                // Step 1: Configuration
                if (step === 1) {
                    return createEl('div', { 
                        style: { 
                            minHeight: '100vh', 
                            background: '#325682', 
                            color: 'white',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: '24px'
                        } 
                    }, [
                        createEl('div', { key: 'container', className: 'container' }, [
                            createEl(DiNKRLogo, { key: 'logo' }),
                            
                            errorMessage ? createEl('div', { key: 'error', className: 'error-message' }, errorMessage) : null,
                            successMessage ? createEl('div', { key: 'success', className: 'success-message' }, successMessage) : null,
                            
                            createEl('div', { key: 'config', className: 'card' }, [
                                createEl('h3', { 
                                    key: 'title', 
                                    style: { 
                                        fontSize: '20px', 
                                        fontWeight: '600', 
                                        marginBottom: '20px', 
                                        color: '#deff01', 
                                        textAlign: 'center' 
                                    } 
                                }, 'Tournament Configuration'),
                                createEl('div', { 
                                    key: 'fields', 
                                    style: { display: 'flex', flexDirection: 'column', gap: '20px' } 
                                }, [
                                    createEl(NumberInput, {
                                        key: 'courts',
                                        value: config.courts,
                                        onChange: handleCourtsChange,
                                        min: 1,
                                        max: 10,
                                        label: 'Number of Courts'
                                    }),
                                    config.useDefaults ? createEl(NumberInput, {
                                        key: 'players',
                                        value: config.totalPlayers,
                                        onChange: handlePlayersChange,
                                        min: config.courts * 4,
                                        max: 100,
                                        label: 'Number of Players',
                                        helpText: `${config.courts * 4} will play each round. Need at least ${config.courts * 4} players.`
                                    }) : null,
                                    createEl(NumberInput, {
                                        key: 'rounds',
                                        value: config.rounds,
                                        onChange: (value) => setConfig(prev => ({...prev, rounds: value})),
                                        min: 3,
                                        max: 15,
                                        label: 'Number of Rounds'
                                    }),
                                    createEl(NumberInput, {
                                        key: 'duration',
                                        value: config.roundDuration,
                                        onChange: (value) => setConfig(prev => ({...prev, roundDuration: value})),
                                        min: 10,
                                        max: 15,
                                        label: 'Round Duration (minutes)',
                                        helpText: 'Range: 10-15 minutes (default: 13)'
                                    })
                                ])
                            ]),
                            
                            // Advanced Options
                            createEl('div', { key: 'advanced', className: 'card' }, [
                                createEl('h3', { 
                                    key: 'title', 
                                    style: { 
                                        fontSize: '18px', 
                                        fontWeight: '600', 
                                        marginBottom: '16px', 
                                        color: '#deff01', 
                                        textAlign: 'center' 
                                    } 
                                }, 'Advanced Options'),
                                createEl('div', { 
                                    key: 'options',
                                    style: { display: 'flex', flexDirection: 'column', gap: '16px' }
                                }, [
                                    createEl('label', { 
                                        key: 'defaults', 
                                        style: { display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' } 
                                    }, [
                                        createEl('input', { type: 'checkbox', checked: config.useDefaults, onChange: (e) => setConfig(prev => ({...prev, useDefaults: e.target.checked})) }),
                                        createEl('span', { style: { fontSize: '14px' } }, 'Use default players (for testing)')
                                    ]),
                                    createEl('label', { 
                                        key: 'gender', 
                                        style: { display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' } 
                                    }, [
                                        createEl('input', { type: 'checkbox', checked: config.avoidMMvsFF, onChange: (e) => setConfig(prev => ({...prev, avoidMMvsFF: e.target.checked})) }),
                                        createEl('span', { style: { fontSize: '14px' } }, 'Avoid Male vs Female matchups')
                                    ]),
                                    createEl('label', { 
                                        key: 'mixed', 
                                        style: { display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' } 
                                    }, [
                                        createEl('input', { type: 'checkbox', checked: config.onlyMixedDoubles, onChange: (e) => setConfig(prev => ({...prev, onlyMixedDoubles: e.target.checked})) }),
                                        createEl('span', { style: { fontSize: '14px' } }, 'Only use MF vs MF matchups')
                                    ]),
                                    createEl('label', { 
                                        key: 'rating', 
                                        style: { display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' } 
                                    }, [
                                        createEl('input', { type: 'checkbox', checked: config.useRatingBalance, onChange: (e) => setConfig(prev => ({...prev, useRatingBalance: e.target.checked})) }),
                                        createEl('span', { style: { fontSize: '14px' } }, 'Create balanced teams by rating')
                                    ])
                                ])
                            ]),
                            
                            !isConfigValid() ? createEl('div', {
                                key: 'config-error',
                                className: 'error-message'
                            }, `‚ö†Ô∏è Need at least ${config.courts * 4} players for ${config.courts} courts.`) : null,
                            
                            loading ? createEl('div', { key: 'loading', className: 'spinner' }) : null,
                            
                            createEl('button', { 
                                key: 'next', 
                                onClick: () => {
                                    if (config.useDefaults) {
                                        generateTournament();
                                    } else {
                                        setStep(2);
                                        // Initialize players if empty
                                        if (players.length === 0) {
                                            const minPlayers = config.courts * 4;
                                            setPlayers(Array.from({ length: minPlayers }, () => ({ firstName: '', lastName: '', gender: 'M', rating: 3.5, name: '' })));
                                        }
                                    }
                                }, 
                                disabled: loading || (config.useDefaults && !isConfigValid()), 
                                className: 'btn', 
                                style: { 
                                    width: '100%', 
                                    backgroundColor: (loading || (config.useDefaults && !isConfigValid())) ? '#64748b' : '#deff01', 
                                    color: '#1e293b', 
                                    padding: '18px', 
                                    fontSize: '18px',
                                    fontWeight: 'bold',
                                    borderRadius: '12px'
                                } 
                            }, loading ? 'Generating...' : 'Next: Enter Players')
                        ])
                    ]);
                }

                // NEW Step 2: Player Entry
                if (step === 2) {
                    return createEl('div', { style: { minHeight: '100vh', background: '#325682' } }, [
                        createEl('div', { key: 'header', className: 'header' }, [
                            createEl('button', { key: 'back', onClick: () => setStep(1), className: 'header-back' }, createEl(ChevronLeft)),
                            createEl('h2', { key: 'title', className: 'header-title' }, 'Enter Players'),
                            createEl('div', { key: 'spacer', className: 'header-spacer' })
                        ]),
                        createEl('div', { key: 'container', className: 'container' }, [
                            errorMessage ? createEl('div', { key: 'error', className: 'error-message' }, errorMessage) : null,
                            createEl('p', { style: { marginBottom: '16px', fontSize: '14px', color: '#cbd5e0' } }, `Enter details for ${players.length} players. You need at least ${config.courts * 4}.`),
                            createEl('div', { style: { display: 'flex', flexDirection: 'column', gap: '16px' } },
                                players.map((p, index) => createEl('div', { key: index, className: 'card', style: { padding: '16px' } }, [
                                    createEl('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' } }, [
                                        createEl('h4', { style: { color: '#deff01' } }, `Player ${index + 1}`),
                                        createEl('button', { onClick: () => removePlayer(index), style: { background: '#dc2626', color: 'white', border: 'none', borderRadius: '4px', padding: '4px 8px', cursor: 'pointer' } }, 'Remove')
                                    ]),
                                    createEl('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' } }, [
                                        createEl('input', { className: 'input', placeholder: 'First Name*', value: p.firstName, onChange: e => handlePlayerInfoChange(index, 'firstName', e.target.value) }),
                                        createEl('input', { className: 'input', placeholder: 'Last Name*', value: p.lastName, onChange: e => handlePlayerInfoChange(index, 'lastName', e.target.value) }),
                                        createEl('select', { className: 'select', value: p.gender, onChange: e => handlePlayerInfoChange(index, 'gender', e.target.value) }, [
                                            createEl('option', { value: 'M' }, 'Male'),
                                            createEl('option', { value: 'F' }, 'Female')
                                        ]),
                                        createEl('input', { type: 'number', step: '0.1', className: 'input', placeholder: 'Rating', value: p.rating, onChange: e => handlePlayerInfoChange(index, 'rating', parseFloat(e.target.value)) })
                                    ])
                                ]))
                            ),
                            createEl('button', { onClick: addPlayer, className: 'btn', style: { width: '100%', background: 'rgba(255,255,255,0.2)', color: 'white', marginTop: '16px' } }, '+ Add Player'),
                            !isConfigValid() ? createEl('div', {
                                key: 'config-error',
                                className: 'error-message'
                            }, `‚ö†Ô∏è Need at least ${config.courts * 4} players and all names must be filled.`) : null,
                            createEl('button', { 
                                onClick: generateTournament,
                                disabled: loading || !isConfigValid(),
                                className: 'btn',
                                style: { width: '100%', background: loading || !isConfigValid() ? '#64748b' : '#deff01', color: '#1a202c', padding: '18px', fontSize: '18px', fontWeight: 'bold', borderRadius: '12px', marginTop: '24px' }
                            }, loading ? 'Generating...' : 'Generate Tournament')
                        ])
                    ]);
                }

                // Step 3: Tournament Play
                if (step === 3 && tournament) {
                    const currentRoundData = tournament.schedule[currentRound];
                    const isCurrentRoundComplete = isRoundComplete(currentRound);
                    const isLastRound = currentRound >= tournament.schedule.length - 1;

                    // FIXED: Tournament Results - no conditional hooks
                    if (phase === 'completed') {
                        if (resultsLoading || !results) {
                            return createEl('div', { 
                                style: { 
                                    minHeight: '100vh', 
                                    background: '#325682', 
                                    color: 'white', 
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    flexDirection: 'column'
                                } 
                            }, [
                                createEl('div', { key: 'loading', className: 'spinner' }),
                                createEl('p', { key: 'text', style: { marginTop: '20px' } }, 'Calculating Results...')
                            ]);
                        }
                        
                        const maleResults = results.pointWinners.male;
                        const femaleResults = results.pointWinners.female;
                        const overallResults = results.dinkrAnalysis.sort((a, b) => b.totalScore - a.totalScore);
                        
                        // Find best performance (highest performance index)
                        const bestPerformance = results.dinkrAnalysis.reduce((best, player) => 
                            player.performanceIndex > best.performanceIndex ? player : best
                        , results.dinkrAnalysis[0]);
                        
                        return createEl('div', { 
                            style: { 
                                minHeight: '100vh', 
                                background: '#325682', 
                                color: 'white', 
                                padding: '24px' 
                            } 
                        }, [
                            createEl('div', { key: 'container', className: 'container' }, [
                                createEl('div', { 
                                    key: 'header', 
                                    style: { textAlign: 'center', marginBottom: '32px' } 
                                }, [
                                    createEl(Trophy, { key: 'trophy' }),
                                    createEl('h1', { 
                                        key: 'title',
                                        style: { fontSize: '32px', fontWeight: 'bold', color: '#deff01', marginTop: '20px' } 
                                    }, 'Tournament Results!')
                                ]),
                                
                                // Gender Winners
                                maleResults.length > 0 ? createEl('div', { key: 'male-winner', className: 'card' }, [
                                    createEl('h3', { 
                                        key: 'title',
                                        style: { fontSize: '18px', fontWeight: 'bold', color: '#deff01', marginBottom: '12px', textAlign: 'center' } 
                                    }, 'ü•á Male Champion'),
                                    createEl('div', { 
                                        key: 'winner',
                                        style: { textAlign: 'center' } 
                                    }, [
                                        createEl('div', { 
                                            key: 'name',
                                            style: { fontSize: '18px', fontWeight: 'bold' } 
                                        }, maleResults[0]?.name),
                                        createEl('div', { 
                                            key: 'score',
                                            style: { fontSize: '14px', color: '#cbd5e0' } 
                                        }, `${maleResults[0]?.totalScore} points`)
                                    ])
                                ]) : null,
                                
                                femaleResults.length > 0 ? createEl('div', { key: 'female-winner', className: 'card' }, [
                                    createEl('h3', { 
                                        key: 'title',
                                        style: { fontSize: '18px', fontWeight: 'bold', color: '#deff01', marginBottom: '12px', textAlign: 'center' } 
                                    }, 'ü•á Female Champion'),
                                    createEl('div', { 
                                        key: 'winner',
                                        style: { textAlign: 'center' } 
                                    }, [
                                        createEl('div', { 
                                            key: 'name',
                                            style: { fontSize: '18px', fontWeight: 'bold' } 
                                        }, femaleResults[0]?.name),
                                        createEl('div', { 
                                            key: 'score',
                                            style: { fontSize: '14px', color: '#cbd5e0' } 
                                        }, `${femaleResults[0]?.totalScore} points`)
                                    ])
                                ]) : null,
                                
                                // Best Performance
                                bestPerformance ? createEl('div', { key: 'best-performance', className: 'card' }, [
                                    createEl('h3', { 
                                        key: 'title',
                                        style: { fontSize: '18px', fontWeight: 'bold', color: '#deff01', marginBottom: '12px', textAlign: 'center' } 
                                    }, '‚≠ê Best Performance'),
                                    createEl('div', { 
                                        key: 'winner',
                                        style: { textAlign: 'center' } 
                                    }, [
                                        createEl('div', { 
                                            key: 'name',
                                            style: { fontSize: '18px', fontWeight: 'bold' } 
                                        }, bestPerformance.name),
                                        createEl('div', { 
                                            key: 'score',
                                            style: { fontSize: '14px', color: '#cbd5e0' } 
                                        }, `Performance Index: ${bestPerformance.performanceIndex.toFixed(3)} (${bestPerformance.performanceLabel})`)
                                    ])
                                ]) : null,
                                
                                // Top Results
                                createEl('div', { key: 'top-results', className: 'card' }, [
                                    createEl('h3', { 
                                        key: 'title',
                                        style: { fontSize: '18px', fontWeight: 'bold', color: '#deff01', marginBottom: '16px', textAlign: 'center' } 
                                    }, 'Final Standings'),
                                    createEl('div', { 
                                        key: 'standings',
                                        className: 'results-grid'
                                    }, overallResults.slice(0, 8).map((player, index) => 
                                        createEl('div', {
                                            key: index,
                                            className: `result-item ${index === 0 ? 'winner' : ''}`
                                        }, [
                                            createEl('div', { key: 'info' }, [
                                                createEl('div', { 
                                                    key: 'name',
                                                    style: { fontWeight: 'bold', fontSize: '16px' } 
                                                }, `${index + 1}. ${player.name}`),
                                                createEl('div', { 
                                                    key: 'details',
                                                    style: { fontSize: '14px', color: '#94a3b8' } 
                                                }, `${player.wins}W-${player.losses}L ‚Ä¢ Avg: ${player.avgScore} ‚Ä¢ ${player.performanceLabel}`)
                                            ]),
                                            createEl('div', { 
                                                key: 'points',
                                                style: { 
                                                    fontSize: '18px', 
                                                    fontWeight: 'bold',
                                                    color: index === 0 ? '#deff01' : 'white'
                                                } 
                                            }, `${player.totalScore}`)
                                        ])
                                    ))
                                ]),
                                
                                createEl('button', { 
                                    key: 'restart', 
                                    onClick: () => { 
                                        setStep(1); 
                                        setTournament(null);
                                        setPhase('setup');
                                        setCurrentRound(0);
                                        setScores({});
                                        setRoundStarted(false);
                                        setTimerRunning(false);
                                        setTimeRemaining(0);
                                        setManagementState({ skipPlayers: [], playerSwitches: [] });
                                        setResults(null);
                                        setResultsLoading(false);
                                    }, 
                                    className: 'btn', 
                                    style: { 
                                        width: '100%',
                                        backgroundColor: '#deff01', 
                                        color: '#1e293b', 
                                        padding: '18px', 
                                        fontSize: '18px',
                                        fontWeight: 'bold',
                                        borderRadius: '12px'
                                    } 
                                }, 'Start New Tournament')
                            ])
                        ]);
                    }

                    return createEl('div', { style: { minHeight: '100vh', background: '#325682' } }, [
                        // Header
                        createEl('div', { key: 'header', className: 'header' }, [
                            createEl('button', { 
                                key: 'back', 
                                onClick: () => setStep(1), 
                                className: 'header-back'
                            }, createEl(ChevronLeft)),
                            createEl('h2', { 
                                key: 'title',
                                className: 'header-title'
                            }, phase === 'setup' ? `SETUP ROUND ${currentRoundData?.round || 1}` : `ROUND ${currentRoundData?.round || 1}`),
                            createEl('button', {
                                key: 'manage',
                                onClick: () => setShowManagement(!showManagement),
                                className: 'header-back',
                                style: { 
                                    backgroundColor: showManagement ? '#deff01' : 'transparent',
                                    color: showManagement ? '#1a202c' : 'white'
                                }
                            }, createEl(Settings))
                        ]),
                        
                        createEl('div', { key: 'content', className: 'container' }, [
                            errorMessage ? createEl('div', { key: 'error', className: 'error-message' }, errorMessage) : null,
                            successMessage ? createEl('div', { key: 'success', className: 'success-message' }, successMessage) : null,
                            
                            // ALWAYS AVAILABLE: Player Management Panel
                            showManagement && tournament ? createEl(PlayerManagement, {
                                key: 'management',
                                players: tournament.players,
                                onUpdate: handleManagementUpdate,
                                currentSkips: managementState.skipPlayers,
                                onlyMixedDoubles: config.onlyMixedDoubles
                            }) : null,
                            
                            // Setup phase
                            phase === 'setup' ? createEl('div', { key: 'setup' }, [
                                createEl('div', { 
                                    key: 'info',
                                    style: { 
                                        backgroundColor: 'rgba(222, 255, 1, 0.2)', 
                                        border: '2px solid #deff01', 
                                        borderRadius: '8px', 
                                        padding: '16px', 
                                        marginBottom: '24px', 
                                        textAlign: 'center'
                                    } 
                                }, [
                                    createEl('h3', { 
                                        key: 'title',
                                        style: { fontSize: '18px', fontWeight: 'bold', marginBottom: '8px' } 
                                    }, `üéØ Round ${currentRoundData?.round} Ready`),
                                    createEl('p', { 
                                        key: 'desc',
                                        style: { fontSize: '14px', marginBottom: '16px' } 
                                    }, 'Review the matches below. Use ‚öôÔ∏è to skip players or make reassignments.'),
                                    createEl('button', {
                                        key: 'start',
                                        onClick: startRound,
                                        className: 'btn',
                                        style: {
                                            backgroundColor: '#16a34a',
                                            color: 'white',
                                            padding: '12px 24px',
                                            fontSize: '16px',
                                            borderRadius: '8px'
                                        }
                                    }, `‚ñ∂Ô∏è Start Round ${currentRoundData?.round}`)
                                ]),
                                
                                // Preview courts (scores disabled)
                                ...currentRoundData.matches.map((match, matchIndex) => 
                                    createEl(Court, { 
                                        key: `preview-${matchIndex}`, 
                                        match, 
                                        matchIndex, 
                                        roundIndex: currentRound, 
                                        courtNumber: matchIndex + 1,
                                        scores: {},
                                        updateScore: () => {},
                                        onScoreValidation: () => {},
                                        roundStarted: false
                                    })
                                ),
                                
                                // Sit outs
                                currentRoundData.sit_outs?.length > 0 ? createEl('div', { 
                                    key: 'sitouts', 
                                    style: { 
                                        backgroundColor: 'rgba(107, 114, 128, 0.5)', 
                                        padding: '16px', 
                                        borderRadius: '8px', 
                                        color: 'white',
                                        textAlign: 'center'
                                    } 
                                }, [
                                    createEl('strong', { key: 'label', style: { color: '#deff01' } }, 'Sitting Out: '), 
                                    currentRoundData.sit_outs.join(', ')
                                ]) : null
                            ]) : [
                                // Playing phase
                                createEl('div', { key: 'timer', style: { textAlign: 'center', marginBottom: '20px' } }, [
                                    roundStarted ? createEl('div', {
                                        key: 'display',
                                        className: `timer-display ${isLastMinute ? 'timer-warning' : 'timer-normal'}`
                                    }, formatTime(timeRemaining)) : null
                                ]),
                                
                                // Active courts (scores enabled)
                                ...currentRoundData.matches.map((match, matchIndex) => 
                                    createEl(Court, { 
                                        key: matchIndex, 
                                        match, 
                                        matchIndex, 
                                        roundIndex: currentRound, 
                                        courtNumber: matchIndex + 1,
                                        scores,
                                        updateScore,
                                        onScoreValidation: handleScoreValidation,
                                        roundStarted
                                    })
                                ),
                                
                                // Sit outs
                                currentRoundData.sit_outs?.length > 0 ? createEl('div', { 
                                    key: 'sitouts', 
                                    style: { 
                                        backgroundColor: 'rgba(107, 114, 128, 0.5)', 
                                        padding: '16px', 
                                        borderRadius: '8px', 
                                        color: 'white',
                                        textAlign: 'center',
                                        marginBottom: '20px'
                                    } 
                                }, [
                                    createEl('strong', { key: 'label', style: { color: '#deff01' } }, 'Sitting Out: '), 
                                    currentRoundData.sit_outs.join(', ')
                                ]) : null,
                                
                                // Next round button
                                isCurrentRoundComplete ? (
                                    loading ? createEl('div', { key: 'loading', className: 'spinner' }) :
                                    createEl('button', { 
                                        key: 'next', 
                                        onClick: advanceRound,
                                        disabled: loading,
                                        className: 'btn', 
                                        style: { 
                                            width: '100%', 
                                            backgroundColor: isLastRound ? '#805ad5' : '#deff01', 
                                            color: isLastRound ? 'white' : '#1a202c', 
                                            padding: '16px', 
                                            fontSize: '18px',
                                            fontWeight: 'bold',
                                            borderRadius: '8px'
                                        } 
                                    }, isLastRound ? 'üèÜ Show Results' : `Next Round (${currentRound + 2}/${tournament.schedule.length})`)
                                ) : createEl('div', { 
                                    key: 'waiting', 
                                    style: { 
                                        width: '100%', 
                                        backgroundColor: '#718096', 
                                        color: '#cbd5e0', 
                                        fontWeight: 'bold', 
                                        padding: '16px', 
                                        borderRadius: '8px', 
                                        fontSize: '18px', 
                                        textAlign: 'center' 
                                    } 
                                }, 'Enter all scores to continue')
                            ],

                            // Score Validation Dialog
                            createEl(ScoreValidationDialog, {
                                key: 'validation',
                                isOpen: scoreValidation.isOpen,
                                onClose: () => setScoreValidation({ ...scoreValidation, isOpen: false }),
                                teamAScore: scoreValidation.teamAScore,
                                teamBScore: scoreValidation.teamBScore,
                                onConfirm: confirmScore
                            })
                        ])
                    ]);
                }

                // Default loading state
                return createEl('div', { 
                    style: { 
                        padding: '40px', 
                        textAlign: 'center', 
                        minHeight: '100vh', 
                        background: '#325682', 
                        color: 'white',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center'
                    } 
                }, [
                    createEl(DiNKRLogo, { key: 'logo', size: 'large' }),
                    createEl('div', { key: 'loading', className: 'spinner' })
                ]);
            };

            // Render the app
            try {
                ReactDOM.render(createEl(TournamentApp), document.getElementById('root'));
                console.log('‚úÖ DiNKR Tournament System loaded successfully');
            } catch (error) {
                console.error('Failed to render app:', error);
                document.getElementById('root').innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #325682; color: white; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <h2 style="color: #dc2626; margin-bottom: 20px;">Rendering Error</h2>
                        <p style="margin-bottom: 20px;">Failed to initialize the tournament system.</p>
                        <button onclick="window.location.reload()" style="background: #deff01; color: #1a202c; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Reload</button>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
